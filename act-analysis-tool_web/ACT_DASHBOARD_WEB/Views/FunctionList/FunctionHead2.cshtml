@{
    ViewBag.Title = "Function";
    DateTime start_time = DateTime.Now.Date.AddDays(-6);
    DateTime end_time = DateTime.Now.Date.AddDays(1).AddSeconds(-1);
    ViewBag.StartDate = start_time.ToString("yyyy-MM-dd HH:mm:ss");
    ViewBag.EndDate = end_time.ToString("yyyy-MM-dd HH:mm:ss");
}

<style>
    .multiselect-container {
        max-height: 200px;
        overflow-y: auto;
    }

    .fixed-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: lightgray;
        border-bottom: 1px solid #ddd;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 10;
    }

    .spinner {
        margin-top: 50px;
        display: none;
    }

        .spinner.active {
            display: block;
        }
</style>

<div class="card shadow mb-3 p-3 pl-5 fixed-header" style="margin-top:55px">
    <form name="search_form" method="post">
        <div class="row mr-2">
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Function</span></div>
                    <select id="select_Function" name="select_Function" class="form-control" onchange="onChangeFunction()">
                        <option value="hw_bin_list">Bin code list - HW bin list</option>
                        <option value="histogram">Histogram - Combine</option>
                    </select>
                </div>
            </div>
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Start Date</span></div>
                    <input id="input_StartDate" name="input_StartDate" type="datetime-local" class="form-control bg-light border-1 small" value="@ViewBag.StartDate" onchange="onChangeDate()">
                </div>
            </div>
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">End Date</span></div>
                    <input id="input_EndDate" name="input_EndDate" type="datetime-local" class="form-control bg-light border-1 small" value="@ViewBag.EndDate" onchange="onChangeDate()">
                </div>
            </div>
        </div>
        <div class="row mr-2">
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">BD</span></div>
                    <select id="select_BD" name="select_BD" class="form-control"></select>
                </div>
            </div>
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Tester</span></div>
                    <select multiple id="select_Tester" name="select_Tester" class="form-control"></select>
                </div>
            </div>
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Lot ID</span></div>
                    <select multiple id="select_Lot" name="select_Lot" class="form-control"></select>
                </div>
            </div>
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Wafer ID</span></div>
                    <select multiple id="select_Wafer" name="select_Wafer" class="form-control" onchange="onChangeWaferId()" disabled></select>
                </div>
            </div>
        </div>
        <div class="row mr-2">
            <div class="col-3 mb-1">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Test Mode</span></div>
                    <select multiple id="select_Test_mode" name="select_Test_mode" class="form-control" onchange="onChangeTestMode()"></select>
                </div>
            </div>
            <div class="col-3 mb-1">
                <div id="select_Test_item_div" class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Test Item</span></div>
                    <select id="select_Test_item" name="select_Test_item" class="form-control"></select>
                </div>
            </div>
            <div class="col-3 mb-1" style="display:none">
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">Site</span></div>
                    <select multiple id="select_Site" name="select_Site" class="form-control"></select>
                </div>
            </div>
            <div class="col-3 input-group mt-1">
                <button class="btn btn-outline-secondary w-50" type="button" data-toggle="modal" data-target="#modal-loadLot">
                    <span class="text">Load Lot File</span>
                </button>
            </div>
            <div class="col-3 input-group mt-1">
                <button class="btn btn-primary w-50" type="button" onclick="onClickStart()">
                    <span class="text">Start</span>
                </button>
            </div>
        </div>
    </form>
</div>

<div class="spinner" id="spinner">
    <div class="center-div">
        <div class="inner-div d-flex justify-content-center">
            <div class="loader"></div>
        </div>
    </div>
</div>

<div id="HW_bin_list_view" style="margin-top: 230px ">
    @Html.Partial("FunctionPart/HwBinListTable")
</div>
<div id="Histogram_combine_view" style="margin-top:230px">
    @Html.Partial("FunctionPart/Histogram_combine")
</div>
<div id="HW_fail_ppm_view" style="height: 800px; margin-top: 230px">
    HW FAIL PPM view
</div>

<!-- modal Load Lot file -->
<div class="modal fade" id="modal-loadLot">
    <div class="modal-dialog  modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-dark">輸入批號</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="InputLotTextarea" class="form-label text-dark">Input Lot:</label>
                    <textarea class="form-control" id="InputLotTextarea" rows="6" placeholder="21NFQAB007&#10;21NFQAB006&#10;21NFQAB005&#10;..."></textarea>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button id="inputModalClose" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="inputModalSave" type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="portfolio-modal modal fade" id="msgModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">訊息</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body align-self-center">
                <h4 id="modalMsg">請選擇 'Test Item'</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">確定</button>
            </div>
        </div>
    </div>
</div>

@Styles.Render("~/vendor/flatpickr/flatpickr.min.css")
@Scripts.Render("~/vendor/flatpickr/flatpickr.js")

<script>
    let selectedBDValues = [], selectedTesterValues = [], selectedLotValues = [], selectedFunction = "", loadLots = [];

    function showSpinner(show) {
        document.getElementById('spinner').classList.toggle('active', show);
    }

    window.addEventListener('DOMContentLoaded', () => {
        showSpinner(true);
        const userAccount = getCookie("userAccount");
        if (userAccount) $("#topnav_right_userid").html('Hi ' + userAccount.split(",")[0]);
        TryToGetAPIData();
        flatpickr(["#input_StartDate", "#input_EndDate"], {
            enableTime: true, dateFormat: "Y-m-d H:i:S", time_24hr: true, enableSeconds: true, seconds: true
        });
        document.getElementById('inputModalSave').addEventListener('click', saveLotModal);
        $('#modal-loadLot').on('hidden.bs.modal', () => $('#InputLotTextarea').val(''));
    });

    function saveLotModal() {
        showSpinner(true);
        loadLots = $('#InputLotTextarea').val().split('\n').map(x => x.trim()).filter(x => x);
        $('#inputModalClose').click();
        onSaveLoadLotFile();
    }

    function onSaveLoadLotFile() {
        updateSelect("select_Lot", loadLots, true);
        $('#select_Lot').multiselect('rebuild');
        $('#input_StartDate,#input_EndDate').val('');
        $('#select_BD,#select_Tester').val('');
        selectedBDValues = [];
        selectedTesterValues = [];
        selectedLotValues = $('#select_Lot').val();
        GetTester(); GetBD(); GetWaferId(); GetTestMode(); GetTestItem();
        showSpinner(false);
    }

    function onChangeFunction() {
        selectedFunction = $('#select_Function').val();
        $('#Histogram_combine_view').toggle(selectedFunction === "histogram");
        $('#HW_bin_list_view').toggle(selectedFunction === "hw_bin_list");
        $('#HW_fail_ppm_view').toggle(selectedFunction === "HW FAIL PPM");
        initializeMultiselect();
        onChangeDate();
        onChangeLotId();
    }

    function onChangeDate() {
        showSpinner(true);
        GetBD(); GetTester(); GetLotId(); GetWaferId();
    }

    function onChangeBD() {
        showSpinner(true);
        selectedBDValues = $('#select_BD').val() || [];
        selectedTesterValues = $('#select_Tester').val() || [];
        selectedLotValues = $('#select_Lot').val() || [];
        GetTester(); GetLotId(); GetWaferId(); GetTestMode();
        if (selectedFunction !== "hw_bin_list") GetTestItem();
    }

    function onChangeTester() {
        showSpinner(true);
        let newVal = $('#select_Tester').val() || [];
        if (!arraysAreEqual(selectedTesterValues, newVal)) {
            selectedTesterValues = newVal;
            GetLotId(); GetBD(); GetWaferId(); GetTestMode();
            if (selectedFunction !== "hw_bin_list") GetTestItem();
        } else {
            showSpinner(false);
        }
    }

    function onChangeLotId() {
        showSpinner(true);
        let newVal = $('#select_Lot').val() || [];
        if (!arraysAreEqual(selectedLotValues, newVal)) {
            selectedLotValues = newVal;
            GetTester(); GetBD(); GetWaferId(); GetTestMode();
            if (selectedFunction !== "hw_bin_list") GetTestItem();
        } else {
            showSpinner(false);
        }
    }

    function initializeMultiselect() {
        const func = $('#select_Function').val();
        // BD
        $('#select_BD').multiselect('destroy');
        if (func === 'histogram') {
            $('#select_BD').removeAttr('multiple').multiselect({ enableFiltering: true, onDropdownHide: onChangeBD });
            $('#select_Test_item_div').show();
            $('#select_Test_item').multiselect('destroy').removeAttr('multiple').multiselect({ enableFiltering: true });
        } else {
            $('#select_BD').attr('multiple', 'multiple').multiselect({ enableFiltering: true, includeSelectAllOption: true, onDropdownHide: onChangeBD });
            if (func === 'hw_bin_list') {
                $('#select_Test_item_div').hide();
            } else {
                $('#select_Test_item_div').show();
                $('#select_Test_item').multiselect('destroy').attr('multiple', 'multiple').multiselect({ enableFiltering: true, includeSelectAllOption: true });
            }
        }
        // 其他
        ['Tester', 'Lot', 'Wafer', 'Test_mode', 'Site'].forEach(id => {
            $('#select_' + id).multiselect('destroy').multiselect({ enableFiltering: true, includeSelectAllOption: true });
        });
    }

    function updateSelect(objID, optionsArray, selectAll = false) {
        const $sel = $('#' + objID).empty();
        if (objID === 'select_BD' && selectedBDValues.length) {
            optionsArray.forEach(opt => $sel.append(`<option value="${opt}"${selectedBDValues.includes(opt) ? ' selected' : ''}>${opt}</option>`));
        } else if (objID === 'select_Tester' && selectedTesterValues.length) {
            optionsArray.forEach(opt => $sel.append(`<option value="${opt}"${selectedTesterValues.includes(opt) ? ' selected' : ''}>${opt}</option>`));
        } else if (objID === 'select_Lot' && selectedLotValues.length) {
            optionsArray.forEach(opt => $sel.append(`<option value="${opt}"${selectedLotValues.includes(opt) ? ' selected' : ''}>${opt}</option>`));
        } else {
            optionsArray.forEach(opt => $sel.append(`<option value="${opt}">${opt}</option>`));
        }
        if (selectAll) $sel.find('option').prop('selected', true);
    }

    function arraysAreEqual(a, b) {
        if (!a || !b) return false;
        if (a.length !== b.length) return false;
        return a.every((v, i) => v === b[i]);
    }

    // AJAX 請求（僅保留核心，細節可再依需求合併/優化）
    function TryToGetAPIData() {
        const postData = getPostData();
        $.post("/MongoAPI/GetBD", postData, function (response) {
            if (response === "Unauthorized") {
                alert('Web API Unauthorized. 請重新整理或聯絡工程師');
                TryToGetAPIData();
            } else {
                pageInit();
            }
        }).fail(() => showSpinner(false));
    }

    function getPostData() {
        const start = new Date($('#input_StartDate').val());
        const end = new Date($('#input_EndDate').val());
        return {
            pageName: $('#select_Function').val(),
            startDate: formatDate(start),
            endDate: formatDate(end),
            bd: $('#select_BD').val(),
            tester: $('#select_Tester').val(),
            lotId: $('#select_Lot').val(),
            waferId: $('#select_Wafer').val(),
            testMode: $('#select_Test_mode').val(),
            testItem: $('#select_Test_item').val(),
            site: $('#select_Site').val()
        };
    }

    // 其餘 GetXXX AJAX 請求可依此模式簡化
    function GetBD() {
        $.post("/MongoAPI/GetBD", getPostData(), function (res) {
            updateSelect("select_BD", res);
            $('#select_BD').multiselect('rebuild');
            showSpinner(false);
        }).fail(() => showSpinner(false));
    }
    function GetTester() {
        $.post("/MongoAPI/GetTester", getPostData(), function (res) {
            updateSelect("select_Tester", res);
            $('#select_Tester').multiselect('rebuild');
            showSpinner(false);
        }).fail(() => showSpinner(false));
    }
    function GetLotId() {
        $.post("/MongoAPI/GetLotId", getPostData(), function (res) {
            updateSelect("select_Lot", res);
            $('#select_Lot').multiselect('rebuild');
            showSpinner(false);
        }).fail(() => showSpinner(false));
    }
    function GetWaferId() {
        $.post("/MongoAPI/GetWaferId", getPostData(), function (res) {
            updateSelect("select_Wafer", res);
            $('#select_Wafer').multiselect('rebuild');
            showSpinner(false);
        }).fail(() => showSpinner(false));
    }
    function GetTestMode() {
        $.post("/MongoAPI/GetTestMode", getPostData(), function (res) {
            updateSelect("select_Test_mode", res);
            $('#select_Test_mode').multiselect('rebuild');
            showSpinner(false);
        }).fail(() => showSpinner(false));
    }
    function GetTestItem() {
        $.post("/MongoAPI/GetTestItem", getPostData(), function (res) {
            updateSelect("select_Test_item", res);
            $('#select_Test_item').multiselect('rebuild');
            showSpinner(false);
        }).fail(() => showSpinner(false));
    }

    function pageInit() {
        initializeMultiselect();
        onChangeFunction();
        // barChartInit(); // 若有 barChartInit 請保留
    }

    function formatDate(date) {
        if (!date) return '';
        return date.getFullYear() + '-' +
            ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
            ('0' + date.getDate()).slice(-2) + ' ' +
            ('0' + date.getHours()).slice(-2) + ':' +
            ('0' + date.getMinutes()).slice(-2) + ':' +
            ('0' + date.getSeconds()).slice(-2);
    }
</script>